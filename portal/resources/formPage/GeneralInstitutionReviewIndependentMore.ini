{
	"action":[
		{
			"code":"ReviewAllocation",
			"name":"复核分配",
			"property":[
				{
					"isHide":false,
					"name":"ReferenceId",
					"value":28173
				},
				{
					"isHide":false,
					"name":"JavaScript",
					"value":"var registerJavaScript = function () {

 

this.BeforeHandler = function () {
   console.log("BeforeHandler");
   var tab=this.Up('[controltype="Tab"]');
   var frm=tab.Down('[controltype="GridPanel"]').First;
   var s=frm.GetSelections();
   if(s.length<=0)
   {
      Framework.Message("请选择项目!","提示");
      return false;
   }
   if(s.length >1)
   {
      Framework.Message("请选择一个项目分配!","提示");
      return false;
   }
   if(AppContext.Profile.id != s[0].actor_id)
   {
      Framework.Message("当前登录人没有复核分配权限!","提示");
      return false;
   }
};

 

};"
				}
			],
			"sort":0
		},
		{
			"code":"Operating",
			"name":"操作",
			"property":[
				{
					"isHide":false,
					"name":"IsRenderColumn",
					"value":"true"
				},
				{
					"isHide":false,
					"name":"OnClick",
					"value":"OperatingFun"
				},
				{
					"isHide":false,
					"name":"JavaScript",
					"value":"var registerJavaScript = function () {

 

this.OperatingFun  = function () {
   console.log("OperatingFun ");
   var tab=this.Up().Up();
   var rs=tab.Down('[controltype="GridPanel"]').First;
   var s=rs.LinkSelectData;
   var url = "UIForm-Web-Schema.json";
   var parameter = {};
   parameter.schemaType = "FormPanel";
   parameter.schemaCode = "ReviewSituationG";
   Framework.OpenForm(me, url, parameter, function (form) {
      form.OpenSelectRow=s;
      if (form.Load) form.Load();
   });
};


 

};"
				}
			],
			"sort":2
		},
		{
			"code":"IssueOpinions",
			"name":"下发意见",
			"property":[
				{
					"isHide":false,
					"name":"OnClick",
					"value":"OnClicka"
				},
				{
					"isHide":false,
					"name":"JavaScript",
					"value":"var registerJavaScript = function () {

 

this.OnClicka=function()
{
    console.log("OnClicka");

    var tab=this.Up('[controltype="Tab"]');
    var frm=tab.Down('[controltype="GridPanel"]').First;
    var selections=frm.GetSelections();
    if(selections.length<=0)
    {
        Framework.Message("请选择项目!","提示");
        return false;
    }

    var lbture=false;
    var lbfaile=false;

    for (var i = 0; i < selections.length; i++) {

        // if(AppContext.Profile.id != selections[i].actor_id)
        // {
        //     Framework.Message("当前登录用户没有下发意见权限，项目名称："+selections[i].name);
        //     break;
        // }
        var params = {};
        params.priId = selections[i].prjId;
        params.reviewOpinionState = 20;//待回复
        params.manuscriptReviewState = selections[i].wfstate;
        params.reviewer=selections[i].actor_id;
        Framework.AjaxRequest(me, "ReviewComments-sendAComment.do", 'post', params, false, function (result) {
            if(result == 0)
            {
                Framework.Message("请先添加复核意见！")
            }else {
                //   btn.SetVisible(true);
                //  Framework.Message("下发意见成功！")
                lbture=true;
            }

        },function (result) {
            Framework.Message("下发复核失败，失败原因："+result);
            lbture=true;
            lbfaile=true;
        },false);
        while(lbture){
            break;
        }
    }
    if(!lbfaile && lbture)
    {
        Framework.Message("下发复核成功！");
        frm.Load();
    }
};

 

};"
				}
			],
			"sort":3
		},
		{
			"code":"WorkFlowPassAll",
			"name":"通过复核",
			"property":[
				{
					"isHide":false,
					"name":"OnClick",
					"value":"WorkFlowPassAll"
				},
				{
					"isHide":false,
					"name":"JavaScript",
					"value":"var registerJavaScript = function () {

 

this.BeforeHandler = function () {
   console.log("BeforeHandler");
   var tab=this.Up('[controltype="Tab"]');
   var frm=tab.Down('[controltype="GridPanel"]').First;
   var s=frm.GetSelections();
   if(s.length<=0)
   {
      Framework.Message("请选择项目!","提示");
      return false;
   }

   if(AppContext.Profile.id != s[0].actor_id)
   {
      Framework.Message("当前登录人没有通过复核权限!","提示");
      return false;
   }
};

 

};"
				}
			],
			"sort":4
		},
		{
			"code":"Back",
			"name":"Back",
			"property":[
				
			],
			"sort":1
		}
	],
	"authority":[
		
	],
	"children":[
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"dateOfSubmission",
			"control":"Date",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"提交日期",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":0
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"wfstate",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"wfstate",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":2
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"hasComments",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"HasComments",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":3
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"prjId",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"prjId",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":4
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"uiFormCode",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"UiFormCode",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":5
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"workitem_Id",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"Workitem_Id",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":6
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"entityId",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"EntityId",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":7
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"actor_id",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"Actor_id",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":8
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"department",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"部门",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"160"
				}
			],
			"sort":9
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"projectManager",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"项目经理",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":10
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"contactTelephone",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"联系人电话",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"130"
				}
			],
			"sort":11
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"name",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"项目名称",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"IsRenderLink",
					"value":"true"
				},
				{
					"isHide":false,
					"name":"SchemaCode",
					"value":"QualityReview"
				},
				{
					"isHide":false,
					"name":"Width",
					"value":"400"
				},
				{
					"isHide":false,
					"name":"halign",
					"value":"center"
				},
				{
					"isHide":false,
					"name":"align",
					"value":"left"
				}
			],
			"sort":12
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"riskLevel",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"风险等级",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"80"
				}
			],
			"sort":13
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"customerType",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"客户类型",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"300"
				}
			],
			"sort":14
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"businessType",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"业务类型",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":15
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"actor_name",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"独立复核人",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":16
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"reviewOpinionState",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"复核进度",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":18
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"remarksOnReview",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"复核情况备注",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":19
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"announcementDate",
			"control":"Date",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"公告日期",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":20
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"reportAvailable",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"可出报告",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"90"
				}
			],
			"sort":21
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"reviewStatus",
			"control":"Text",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"复核状态",
			"otherChildren":[
				
			],
			"property":[
				{
					"isHide":false,
					"name":"Width",
					"value":"120"
				}
			],
			"sort":17
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"allocations",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"javaScript":"",
			"name":"Allocations",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":1
		},
		{
			"action":[
				
			],
			"authority":[
				
			],
			"children":[
				
			],
			"code":"uuid",
			"control":"Hidden",
			"dataPermission":[
				
			],
			"isReference":false,
			"name":"uuid",
			"otherChildren":[
				
			],
			"property":[
				
			],
			"sort":1000
		}
	],
	"code":"generalInstitutionReviewIndependentMore",
	"control":"GridPanel",
	"dataPermission":[
		
	],
	"isReference":false,
	"javaScript":"this.BeforeLoad = function () {
    console.log("BeforeLoad");
    var ReviewAllocation = this.ToolBar.DownForCode("ReviewAllocation");
    var WorkFlowPassAll =this.ToolBar.DownForCode("WorkFlowPassAll");
    var pp={};
    Framework.AjaxRequest(me, "DraftReviewBatch-judgeReviewManager.do", 'post', pp, false, function (result) {
        if(result)
        {
            ReviewAllocation.SetVisible(false);
            WorkFlowPassAll.SetVisible(true)
        }else{
            ReviewAllocation.SetVisible(true);
            WorkFlowPassAll.SetVisible(true)
        }

    },function (result) {


    },false);
};
this.AfterRender = function (){
    console.log('AfterRender ');
    this.Load();
};
this.OpenLinkForm = function (row) {
    console.log('RunNextFun');

    var mainGrid = this;

    var selected = row;
    if (Framework.IsNullOrEmpty(selected.uiFormCode)) Framework.Message("未找到流程表单！");

    var url = "UIForm-Web-Schema.json";
    var parameter = {};
    parameter.schemaCode = selected.uiFormCode;
    parameter.schemaType = "FormPanel";
    parameter.reference = false;
    parameter.workItemId = selected.workitem_Id;

    var data = {};
    data.id = selected.entityId;
    data.workItemId = selected.workitem_Id;

    if (data.id) {
        Framework.OpenForm(mainGrid, url, parameter, function (form) {
            form.OpenSelectRow=row;
            if(row.reviewOpinionState =="待回复")
            {
                form.isHaveOper ="F";
            }

            if (form.Load) form.Load(data);
        });
    }
};
this.SetActionColumnVisible = function (item, row) {
    // console.log("后期加当前所属分所的判断，如果是北京总所就隐藏（返回true）");
    if(item.code=="Operating")
    {
        if(AppContext.Profile.orgName =="北京业务总部")
        {
            return false;
        }else
        {
            return true;//true 测试用
        }

    }
};
this.RenderRowStyler = function (index, row) {
    console.log('RegisterSearch');
    if(Framework.IsNullOrEmpty(row.reviewOpinionState))
    {
        // return 'background-color:#ffffff';
        return;
    }
    if( row.reviewOpinionState =="回复待处理" ) // 提醒
    {
        return 'background-color:#f2dcac';

    }else
    {
        // return 'background-color:#ffffff';
    }
};",
	"name":"独立复核复核中（更多）",
	"otherChildren":[
		
	],
	"property":[
		{
			"isHide":false,
			"name":"BaseCode",
			"value":"generalInstitutionReviewIndependentMore"
		},
		{
			"isHide":false,
			"name":"Name",
			"value":"独立复核复核中（更多）"
		},
		{
			"isHide":false,
			"name":"IsReadOnly",
			"value":false
		},
		{
			"isHide":false,
			"name":"Description"
		},
		{
			"isHide":false,
			"name":"FormId",
			"value":342978
		},
		{
			"isHide":false,
			"name":"OrderBy",
			"value":"DateOfSubmission"
		},
		{
			"isHide":false,
			"name":"IsSqlForm",
			"value":true
		},
		{
			"isHide":false,
			"name":"JavaScript",
			"value":"var registerJavaScript = function () {

 

this.BeforeLoad = function () {
    console.log("BeforeLoad");
    var ReviewAllocation = this.ToolBar.DownForCode("ReviewAllocation");
    var WorkFlowPassAll =this.ToolBar.DownForCode("WorkFlowPassAll");
    var pp={};
    Framework.AjaxRequest(me, "DraftReviewBatch-judgeReviewManager.do", 'post', pp, false, function (result) {
        if(result)
        {
            ReviewAllocation.SetVisible(false);
            WorkFlowPassAll.SetVisible(true)
        }else{
            ReviewAllocation.SetVisible(true);
            WorkFlowPassAll.SetVisible(true)
        }

    },function (result) {


    },false);
};
this.AfterRender = function (){
    console.log('AfterRender ');
    this.Load();
};
this.OpenLinkForm = function (row) {
    console.log('RunNextFun');

    var mainGrid = this;

    var selected = row;
    if (Framework.IsNullOrEmpty(selected.uiFormCode)) Framework.Message("未找到流程表单！");

    var url = "UIForm-Web-Schema.json";
    var parameter = {};
    parameter.schemaCode = selected.uiFormCode;
    parameter.schemaType = "FormPanel";
    parameter.reference = false;
    parameter.workItemId = selected.workitem_Id;

    var data = {};
    data.id = selected.entityId;
    data.workItemId = selected.workitem_Id;

    if (data.id) {
        Framework.OpenForm(mainGrid, url, parameter, function (form) {
            form.OpenSelectRow=row;
            if(row.reviewOpinionState =="待回复")
            {
                form.isHaveOper ="F";
            }

            if (form.Load) form.Load(data);
        });
    }
};
this.SetActionColumnVisible = function (item, row) {
    // console.log("后期加当前所属分所的判断，如果是北京总所就隐藏（返回true）");
    if(item.code=="Operating")
    {
        if(AppContext.Profile.orgName =="北京业务总部")
        {
            return false;
        }else
        {
            return true;//true 测试用
        }

    }
};
this.RenderRowStyler = function (index, row) {
    console.log('RegisterSearch');
    if(Framework.IsNullOrEmpty(row.reviewOpinionState))
    {
        // return 'background-color:#ffffff';
        return;
    }
    if( row.reviewOpinionState =="回复待处理" ) // 提醒
    {
        return 'background-color:#f2dcac';

    }else
    {
        // return 'background-color:#ffffff';
    }
};

 

};"
		},
		{
			"isHide":false,
			"name":"checkbox",
			"value":"true"
		}
	],
	"sort":0,
	"sql":"select 'QualityReview' as 'uiFormCode',workitem_Id,processinstance_id,
entityId,entitytype,
process_id,activity_dispalyname,
creator_name,actor_id,
(select top 1 left(stulist,len(stulist)-1) as actor_name from (
select (select u1.name+',' from base_user u1 where u1.id in (select userid  from qr_reviewallocation ra,qr_draftreviewbatch db where db.id=ra.draftreviewbatchid and db.id=b.id group by ra.userid,db.id) for xml path('')) as stulist from   base_user u2 where u2.id in (select userid  from qr_reviewallocation ra,qr_draftreviewbatch db where db.id=ra.draftreviewbatchid and db.id=b.id group by ra.userid,db.id) ) b) as actor_name,
post,workitem_state,
created_time as 'dateOfSubmission',comments,taskinStance_Name,
step_number,tododescription,formurl,
batchapproval,flowcode   ,
(select u.name from base_user u where u.id = p.projectmanagerid) as 'projectManager',
(select u.name from base_user u where u.id = p.projectpartnerid) as 'projectPartnerId',
(select isnull(d.treename,d.name) from Base_Department d where d.id = p.deptid) as 'department',
(select  staff.MobilePhone from base_user u left join HR_Staff staff on u.staffid = staff.id where u.id = p.projectmanagerid) as 'contactTelephone',
(select v.name from sys_enumvalue v,sys_enumtype t where v.enumtypeid=t.id and t.code='risklevel' and v.value=p.risklevel)as riskLevel ,
p.businesstypevalue as 'businessType'
,p.customertypevalue as 'customerType',
(select v.name from sys_enumvalue v,sys_enumtype et where v.enumtypeid=et.id and et.code='ManuscriptReviewStateType' and v.value=t.entityStatus)as 'reviewStatus' ,

p.code,p.ShowName as 'name',p.id as 'prjId'
,(select v.name from sys_enumvalue v,sys_enumtype et where v.enumtypeid=et.id and et.code='ReviewOpinionStateType' and v.value=p.ReviewOpinionState)as 'ReviewOpinionState' 
,b.generalReviewNotes as 'remarksOnReview',b.generalDate as 'announcementDate',case b.generalReport when 10 then '是' else '' end as 'reportAvailable'
,b.hasComments,t.entityStatus as 'wfstate'
,(select count(☆) + 1 from QR_ReviewAllocation where draftReviewBatchId=b.id and userid <>actor_id 
and manuscriptReviewState=t.entityStatus) as 'Allocations'
from wf_todo t
inner join  qr_draftreviewbatch b  on t.entityid=b.id
inner join prj_project p on b.projectid=p.id

where  t.workitem_state = 10 and t.flowcode is not  null  
and exists (select code from Base_WorkFlowConfig where workflowtypeid =24615 and flowcode =code) 
and t.entityStatus in('50','60')

and (exists 
(select ☆ from dbo.Base_Department d,Base_Department df,base_usergroupitem item
where p.deptid = d.id and d.orgId =df.id and item.usergroupid = df.qualityControlGroupId and item.userid =#AppContext.Profile.Id#) or actor_id =#AppContext.Profile.Id#)
and exists (select ☆ from qr_reviewallocation a where  b.id=a.draftreviewbatchid and a.manuscriptReviewState = t.entityStatus and (a.userid=#AppContext.Profile.Id# or actor_id =#AppContext.Profile.Id#))
"
}
{"action":[{"code":"ReviewAllocation","name":"复核分配","property":[{"isHide":false,"name":"ReferenceId","value":28173},{"isHide":false,"name":"JavaScript","value":"var registerJavaScript = function () {\r\n \r\nthis.BeforeHandler&nbsp;=&nbsp;function&nbsp;()&nbsp;{\n&nbsp;&nbsp;&nbsp;console.log(&quot;BeforeHandler&quot;);\n&nbsp;&nbsp;&nbsp;var&nbsp;tab=this.Up('[controltype=&quot;Tab&quot;]');\n&nbsp;&nbsp;&nbsp;var&nbsp;frm=tab.Down('[controltype=&quot;GridPanel&quot;]').First;\n&nbsp;&nbsp;&nbsp;var&nbsp;s=frm.GetSelections();\n&nbsp;&nbsp;&nbsp;if(s.length&lt;=0)\n&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;请选择项目!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;if(s.length&nbsp;&gt;1)\n&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;请选择一个项目分配!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;if(AppContext.Profile.id&nbsp;!=&nbsp;s[0].actor_id)\n&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;当前登录人没有复核分配权限!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;}\n};\r\n \r\n};"}],"sort":0},{"code":"Operating","name":"操作","property":[{"isHide":false,"name":"IsRenderColumn","value":"true"},{"isHide":false,"name":"OnClick","value":"OperatingFun"},{"isHide":false,"name":"JavaScript","value":"var registerJavaScript = function () {\r\n \r\nthis.OperatingFun&nbsp;&nbsp;=&nbsp;function&nbsp;()&nbsp;{\n&nbsp;&nbsp;&nbsp;console.log(&quot;OperatingFun&nbsp;&quot;);\n&nbsp;&nbsp;&nbsp;var&nbsp;tab=this.Up().Up();\n&nbsp;&nbsp;&nbsp;var&nbsp;rs=tab.Down('[controltype=&quot;GridPanel&quot;]').First;\n&nbsp;&nbsp;&nbsp;var&nbsp;s=rs.LinkSelectData;\n&nbsp;&nbsp;&nbsp;var&nbsp;url&nbsp;=&nbsp;&quot;UIForm-Web-Schema.json&quot;;\n&nbsp;&nbsp;&nbsp;var&nbsp;parameter&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;parameter.schemaType&nbsp;=&nbsp;&quot;FormPanel&quot;;\n&nbsp;&nbsp;&nbsp;parameter.schemaCode&nbsp;=&nbsp;&quot;ReviewSituationG&quot;;\n&nbsp;&nbsp;&nbsp;Framework.OpenForm(me,&nbsp;url,&nbsp;parameter,&nbsp;function&nbsp;(form)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form.OpenSelectRow=s;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(form.Load)&nbsp;form.Load();\n&nbsp;&nbsp;&nbsp;});\n};\n\r\n \r\n};"}],"sort":2},{"code":"IssueOpinions","name":"下发意见","property":[{"isHide":false,"name":"OnClick","value":"OnClicka"},{"isHide":false,"name":"JavaScript","value":"var registerJavaScript = function () {\r\n \r\nthis.OnClicka=function()\n{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log(&quot;OnClicka&quot;);\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;tab=this.Up('[controltype=&quot;Tab&quot;]');\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;frm=tab.Down('[controltype=&quot;GridPanel&quot;]').First;\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;selections=frm.GetSelections();\n&nbsp;&nbsp;&nbsp;&nbsp;if(selections.length&lt;=0)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;请选择项目!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;lbture=false;\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;lbfaile=false;\n\n&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;selections.length;&nbsp;i++)&nbsp;{\n\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if(AppContext.Profile.id&nbsp;!=&nbsp;selections[i].actor_id)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;当前登录用户没有下发意见权限，项目名称：&quot;+selections[i].name);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;params&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params.priId&nbsp;=&nbsp;selections[i].prjId;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params.reviewOpinionState&nbsp;=&nbsp;20;//待回复\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params.manuscriptReviewState&nbsp;=&nbsp;selections[i].wfstate;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params.reviewer=selections[i].actor_id;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.AjaxRequest(me,&nbsp;&quot;ReviewComments-sendAComment.do&quot;,&nbsp;'post',&nbsp;params,&nbsp;false,&nbsp;function&nbsp;(result)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(result&nbsp;==&nbsp;0)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;请先添加复核意见！&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;btn.SetVisible(true);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;Framework.Message(&quot;下发意见成功！&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lbture=true;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},function&nbsp;(result)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;下发复核失败，失败原因：&quot;+result);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lbture=true;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lbfaile=true;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},false);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(lbture){\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;if(!lbfaile&nbsp;&&&nbsp;lbture)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;下发复核成功！&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frm.Load();\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\r\n \r\n};"}],"sort":3},{"code":"WorkFlowPassAll","name":"通过复核","property":[{"isHide":false,"name":"OnClick","value":"WorkFlowPassAll"},{"isHide":false,"name":"JavaScript","value":"var registerJavaScript = function () {\r\n \r\nthis.BeforeHandler&nbsp;=&nbsp;function&nbsp;()&nbsp;{\n&nbsp;&nbsp;&nbsp;console.log(&quot;BeforeHandler&quot;);\n&nbsp;&nbsp;&nbsp;var&nbsp;tab=this.Up('[controltype=&quot;Tab&quot;]');\n&nbsp;&nbsp;&nbsp;var&nbsp;frm=tab.Down('[controltype=&quot;GridPanel&quot;]').First;\n&nbsp;&nbsp;&nbsp;var&nbsp;s=frm.GetSelections();\n&nbsp;&nbsp;&nbsp;if(s.length&lt;=0)\n&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;请选择项目!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;if(AppContext.Profile.id&nbsp;!=&nbsp;s[0].actor_id)\n&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.Message(&quot;当前登录人没有通过复核权限!&quot;,&quot;提示&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;}\n};\r\n \r\n};"}],"sort":4},{"code":"Back","name":"Back","property":[],"sort":1}],"authority":[],"children":[{"action":[],"authority":[],"children":[],"code":"dateOfSubmission","control":"Date","dataPermission":[],"isReference":false,"name":"提交日期","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":0},{"action":[],"authority":[],"children":[],"code":"wfstate","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"wfstate","otherChildren":[],"property":[],"sort":2},{"action":[],"authority":[],"children":[],"code":"hasComments","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"HasComments","otherChildren":[],"property":[],"sort":3},{"action":[],"authority":[],"children":[],"code":"prjId","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"prjId","otherChildren":[],"property":[],"sort":4},{"action":[],"authority":[],"children":[],"code":"uiFormCode","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"UiFormCode","otherChildren":[],"property":[],"sort":5},{"action":[],"authority":[],"children":[],"code":"workitem_Id","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"Workitem_Id","otherChildren":[],"property":[],"sort":6},{"action":[],"authority":[],"children":[],"code":"entityId","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"EntityId","otherChildren":[],"property":[],"sort":7},{"action":[],"authority":[],"children":[],"code":"actor_id","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"Actor_id","otherChildren":[],"property":[],"sort":8},{"action":[],"authority":[],"children":[],"code":"department","control":"Text","dataPermission":[],"isReference":false,"name":"部门","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"160"}],"sort":9},{"action":[],"authority":[],"children":[],"code":"projectManager","control":"Text","dataPermission":[],"isReference":false,"name":"项目经理","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":10},{"action":[],"authority":[],"children":[],"code":"contactTelephone","control":"Text","dataPermission":[],"isReference":false,"name":"联系人电话","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"130"}],"sort":11},{"action":[],"authority":[],"children":[],"code":"name","control":"Text","dataPermission":[],"isReference":false,"name":"项目名称","otherChildren":[],"property":[{"isHide":false,"name":"IsRenderLink","value":"true"},{"isHide":false,"name":"SchemaCode","value":"QualityReview"},{"isHide":false,"name":"Width","value":"400"},{"isHide":false,"name":"halign","value":"center"},{"isHide":false,"name":"align","value":"left"}],"sort":12},{"action":[],"authority":[],"children":[],"code":"riskLevel","control":"Text","dataPermission":[],"isReference":false,"name":"风险等级","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"80"}],"sort":13},{"action":[],"authority":[],"children":[],"code":"customerType","control":"Text","dataPermission":[],"isReference":false,"name":"客户类型","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"300"}],"sort":14},{"action":[],"authority":[],"children":[],"code":"businessType","control":"Text","dataPermission":[],"isReference":false,"name":"业务类型","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":15},{"action":[],"authority":[],"children":[],"code":"actor_name","control":"Text","dataPermission":[],"isReference":false,"name":"独立复核人","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":16},{"action":[],"authority":[],"children":[],"code":"reviewOpinionState","control":"Text","dataPermission":[],"isReference":false,"name":"复核进度","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":18},{"action":[],"authority":[],"children":[],"code":"remarksOnReview","control":"Text","dataPermission":[],"isReference":false,"name":"复核情况备注","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":19},{"action":[],"authority":[],"children":[],"code":"announcementDate","control":"Date","dataPermission":[],"isReference":false,"name":"公告日期","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":20},{"action":[],"authority":[],"children":[],"code":"reportAvailable","control":"Text","dataPermission":[],"isReference":false,"name":"可出报告","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"90"}],"sort":21},{"action":[],"authority":[],"children":[],"code":"reviewStatus","control":"Text","dataPermission":[],"isReference":false,"name":"复核状态","otherChildren":[],"property":[{"isHide":false,"name":"Width","value":"120"}],"sort":17},{"action":[],"authority":[],"children":[],"code":"allocations","control":"Hidden","dataPermission":[],"isReference":false,"javaScript":"","name":"Allocations","otherChildren":[],"property":[],"sort":1},{"action":[],"authority":[],"children":[],"code":"uuid","control":"Hidden","dataPermission":[],"isReference":false,"name":"uuid","otherChildren":[],"property":[],"sort":1000}],"code":"generalInstitutionReviewIndependentMore","control":"GridPanel","dataPermission":[],"isReference":false,"javaScript":"this.BeforeLoad&nbsp;=&nbsp;function&nbsp;()&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log(&quot;BeforeLoad&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;ReviewAllocation&nbsp;=&nbsp;this.ToolBar.DownForCode(&quot;ReviewAllocation&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;WorkFlowPassAll&nbsp;=this.ToolBar.DownForCode(&quot;WorkFlowPassAll&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;pp={};\n&nbsp;&nbsp;&nbsp;&nbsp;Framework.AjaxRequest(me,&nbsp;&quot;DraftReviewBatch-judgeReviewManager.do&quot;,&nbsp;'post',&nbsp;pp,&nbsp;false,&nbsp;function&nbsp;(result)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(result)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReviewAllocation.SetVisible(false);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WorkFlowPassAll.SetVisible(true)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReviewAllocation.SetVisible(true);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WorkFlowPassAll.SetVisible(true)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;},function&nbsp;(result)&nbsp;{\n\n\n&nbsp;&nbsp;&nbsp;&nbsp;},false);\n};\nthis.AfterRender&nbsp;=&nbsp;function&nbsp;(){\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('AfterRender&nbsp;');\n&nbsp;&nbsp;&nbsp;&nbsp;this.Load();\n};\nthis.OpenLinkForm&nbsp;=&nbsp;function&nbsp;(row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('RunNextFun');\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;mainGrid&nbsp;=&nbsp;this;\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;selected&nbsp;=&nbsp;row;\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Framework.IsNullOrEmpty(selected.uiFormCode))&nbsp;Framework.Message(&quot;未找到流程表单！&quot;);\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;url&nbsp;=&nbsp;&quot;UIForm-Web-Schema.json&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;parameter&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.schemaCode&nbsp;=&nbsp;selected.uiFormCode;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.schemaType&nbsp;=&nbsp;&quot;FormPanel&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.reference&nbsp;=&nbsp;false;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.workItemId&nbsp;=&nbsp;selected.workitem_Id;\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;data&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;&nbsp;data.id&nbsp;=&nbsp;selected.entityId;\n&nbsp;&nbsp;&nbsp;&nbsp;data.workItemId&nbsp;=&nbsp;selected.workitem_Id;\n\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(data.id)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.OpenForm(mainGrid,&nbsp;url,&nbsp;parameter,&nbsp;function&nbsp;(form)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form.OpenSelectRow=row;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(row.reviewOpinionState&nbsp;==&quot;待回复&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form.isHaveOper&nbsp;=&quot;F&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(form.Load)&nbsp;form.Load(data);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\nthis.SetActionColumnVisible&nbsp;=&nbsp;function&nbsp;(item,&nbsp;row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;console.log(&quot;后期加当前所属分所的判断，如果是北京总所就隐藏（返回true）&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;if(item.code==&quot;Operating&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(AppContext.Profile.orgName&nbsp;==&quot;北京业务总部&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;//true&nbsp;测试用\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\nthis.RenderRowStyler&nbsp;=&nbsp;function&nbsp;(index,&nbsp;row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('RegisterSearch');\n&nbsp;&nbsp;&nbsp;&nbsp;if(Framework.IsNullOrEmpty(row.reviewOpinionState))\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;'background-color:#ffffff';\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;row.reviewOpinionState&nbsp;==&quot;回复待处理&quot;&nbsp;)&nbsp;//&nbsp;提醒\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;'background-color:#f2dcac';\n\n&nbsp;&nbsp;&nbsp;&nbsp;}else\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;'background-color:#ffffff';\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};","name":"独立复核复核中（更多）","otherChildren":[],"property":[{"isHide":false,"name":"BaseCode","value":"generalInstitutionReviewIndependentMore"},{"isHide":false,"name":"Name","value":"独立复核复核中（更多）"},{"isHide":false,"name":"IsReadOnly","value":false},{"isHide":false,"name":"Description"},{"isHide":false,"name":"FormId","value":342978},{"isHide":false,"name":"OrderBy","value":"DateOfSubmission"},{"isHide":false,"name":"IsSqlForm","value":true},{"isHide":false,"name":"JavaScript","value":"var registerJavaScript = function () {\r\n \r\nthis.BeforeLoad&nbsp;=&nbsp;function&nbsp;()&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log(&quot;BeforeLoad&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;ReviewAllocation&nbsp;=&nbsp;this.ToolBar.DownForCode(&quot;ReviewAllocation&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;WorkFlowPassAll&nbsp;=this.ToolBar.DownForCode(&quot;WorkFlowPassAll&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;pp={};\n&nbsp;&nbsp;&nbsp;&nbsp;Framework.AjaxRequest(me,&nbsp;&quot;DraftReviewBatch-judgeReviewManager.do&quot;,&nbsp;'post',&nbsp;pp,&nbsp;false,&nbsp;function&nbsp;(result)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(result)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReviewAllocation.SetVisible(false);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WorkFlowPassAll.SetVisible(true)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReviewAllocation.SetVisible(true);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WorkFlowPassAll.SetVisible(true)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;},function&nbsp;(result)&nbsp;{\n\n\n&nbsp;&nbsp;&nbsp;&nbsp;},false);\n};\nthis.AfterRender&nbsp;=&nbsp;function&nbsp;(){\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('AfterRender&nbsp;');\n&nbsp;&nbsp;&nbsp;&nbsp;this.Load();\n};\nthis.OpenLinkForm&nbsp;=&nbsp;function&nbsp;(row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('RunNextFun');\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;mainGrid&nbsp;=&nbsp;this;\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;selected&nbsp;=&nbsp;row;\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Framework.IsNullOrEmpty(selected.uiFormCode))&nbsp;Framework.Message(&quot;未找到流程表单！&quot;);\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;url&nbsp;=&nbsp;&quot;UIForm-Web-Schema.json&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;parameter&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.schemaCode&nbsp;=&nbsp;selected.uiFormCode;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.schemaType&nbsp;=&nbsp;&quot;FormPanel&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.reference&nbsp;=&nbsp;false;\n&nbsp;&nbsp;&nbsp;&nbsp;parameter.workItemId&nbsp;=&nbsp;selected.workitem_Id;\n\n&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;data&nbsp;=&nbsp;{};\n&nbsp;&nbsp;&nbsp;&nbsp;data.id&nbsp;=&nbsp;selected.entityId;\n&nbsp;&nbsp;&nbsp;&nbsp;data.workItemId&nbsp;=&nbsp;selected.workitem_Id;\n\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(data.id)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framework.OpenForm(mainGrid,&nbsp;url,&nbsp;parameter,&nbsp;function&nbsp;(form)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form.OpenSelectRow=row;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(row.reviewOpinionState&nbsp;==&quot;待回复&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form.isHaveOper&nbsp;=&quot;F&quot;;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(form.Load)&nbsp;form.Load(data);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\nthis.SetActionColumnVisible&nbsp;=&nbsp;function&nbsp;(item,&nbsp;row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;console.log(&quot;后期加当前所属分所的判断，如果是北京总所就隐藏（返回true）&quot;);\n&nbsp;&nbsp;&nbsp;&nbsp;if(item.code==&quot;Operating&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(AppContext.Profile.orgName&nbsp;==&quot;北京业务总部&quot;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;//true&nbsp;测试用\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\nthis.RenderRowStyler&nbsp;=&nbsp;function&nbsp;(index,&nbsp;row)&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;console.log('RegisterSearch');\n&nbsp;&nbsp;&nbsp;&nbsp;if(Framework.IsNullOrEmpty(row.reviewOpinionState))\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;'background-color:#ffffff';\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;row.reviewOpinionState&nbsp;==&quot;回复待处理&quot;&nbsp;)&nbsp;//&nbsp;提醒\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;'background-color:#f2dcac';\n\n&nbsp;&nbsp;&nbsp;&nbsp;}else\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;'background-color:#ffffff';\n&nbsp;&nbsp;&nbsp;&nbsp;}\n};\r\n \r\n};"},{"isHide":false,"name":"checkbox","value":"true"}],"sort":0,"sql":"select&nbsp;'QualityReview'&nbsp;as&nbsp;'uiFormCode',workitem_Id,processinstance_id,\nentityId,entitytype,\nprocess_id,activity_dispalyname,\ncreator_name,actor_id,\n(select&nbsp;top&nbsp;1&nbsp;left(stulist,len(stulist)-1)&nbsp;as&nbsp;actor_name&nbsp;from&nbsp;(\nselect&nbsp;(select&nbsp;u1.name+','&nbsp;from&nbsp;base_user&nbsp;u1&nbsp;where&nbsp;u1.id&nbsp;in&nbsp;(select&nbsp;userid&nbsp;&nbsp;from&nbsp;qr_reviewallocation&nbsp;ra,qr_draftreviewbatch&nbsp;db&nbsp;where&nbsp;db.id=ra.draftreviewbatchid&nbsp;and&nbsp;db.id=b.id&nbsp;group&nbsp;by&nbsp;ra.userid,db.id)&nbsp;for&nbsp;xml&nbsp;path(''))&nbsp;as&nbsp;stulist&nbsp;from&nbsp;&nbsp;&nbsp;base_user&nbsp;u2&nbsp;where&nbsp;u2.id&nbsp;in&nbsp;(select&nbsp;userid&nbsp;&nbsp;from&nbsp;qr_reviewallocation&nbsp;ra,qr_draftreviewbatch&nbsp;db&nbsp;where&nbsp;db.id=ra.draftreviewbatchid&nbsp;and&nbsp;db.id=b.id&nbsp;group&nbsp;by&nbsp;ra.userid,db.id)&nbsp;)&nbsp;b)&nbsp;as&nbsp;actor_name,\npost,workitem_state,\ncreated_time&nbsp;as&nbsp;'dateOfSubmission',comments,taskinStance_Name,\nstep_number,tododescription,formurl,\nbatchapproval,flowcode&nbsp;&nbsp;&nbsp;,\n(select&nbsp;u.name&nbsp;from&nbsp;base_user&nbsp;u&nbsp;where&nbsp;u.id&nbsp;=&nbsp;p.projectmanagerid)&nbsp;as&nbsp;'projectManager',\n(select&nbsp;u.name&nbsp;from&nbsp;base_user&nbsp;u&nbsp;where&nbsp;u.id&nbsp;=&nbsp;p.projectpartnerid)&nbsp;as&nbsp;'projectPartnerId',\n(select&nbsp;isnull(d.treename,d.name)&nbsp;from&nbsp;Base_Department&nbsp;d&nbsp;where&nbsp;d.id&nbsp;=&nbsp;p.deptid)&nbsp;as&nbsp;'department',\n(select&nbsp;&nbsp;staff.MobilePhone&nbsp;from&nbsp;base_user&nbsp;u&nbsp;left&nbsp;join&nbsp;HR_Staff&nbsp;staff&nbsp;on&nbsp;u.staffid&nbsp;=&nbsp;staff.id&nbsp;where&nbsp;u.id&nbsp;=&nbsp;p.projectmanagerid)&nbsp;as&nbsp;'contactTelephone',\n(select&nbsp;v.name&nbsp;from&nbsp;sys_enumvalue&nbsp;v,sys_enumtype&nbsp;t&nbsp;where&nbsp;v.enumtypeid=t.id&nbsp;and&nbsp;t.code='risklevel'&nbsp;and&nbsp;v.value=p.risklevel)as&nbsp;riskLevel&nbsp;,\np.businesstypevalue&nbsp;as&nbsp;'businessType'\n,p.customertypevalue&nbsp;as&nbsp;'customerType',\n(select&nbsp;v.name&nbsp;from&nbsp;sys_enumvalue&nbsp;v,sys_enumtype&nbsp;et&nbsp;where&nbsp;v.enumtypeid=et.id&nbsp;and&nbsp;et.code='ManuscriptReviewStateType'&nbsp;and&nbsp;v.value=t.entityStatus)as&nbsp;'reviewStatus'&nbsp;,\n\np.code,p.ShowName&nbsp;as&nbsp;'name',p.id&nbsp;as&nbsp;'prjId'\n,(select&nbsp;v.name&nbsp;from&nbsp;sys_enumvalue&nbsp;v,sys_enumtype&nbsp;et&nbsp;where&nbsp;v.enumtypeid=et.id&nbsp;and&nbsp;et.code='ReviewOpinionStateType'&nbsp;and&nbsp;v.value=p.ReviewOpinionState)as&nbsp;'ReviewOpinionState'&nbsp;\n,b.generalReviewNotes&nbsp;as&nbsp;'remarksOnReview',b.generalDate&nbsp;as&nbsp;'announcementDate',case&nbsp;b.generalReport&nbsp;when&nbsp;10&nbsp;then&nbsp;'是'&nbsp;else&nbsp;''&nbsp;end&nbsp;as&nbsp;'reportAvailable'\n,b.hasComments,t.entityStatus&nbsp;as&nbsp;'wfstate'\n,(select&nbsp;count(*)&nbsp;+&nbsp;1&nbsp;from&nbsp;QR_ReviewAllocation&nbsp;where&nbsp;draftReviewBatchId=b.id&nbsp;and&nbsp;userid&nbsp;&lt;&gt;actor_id&nbsp;\nand&nbsp;manuscriptReviewState=t.entityStatus)&nbsp;as&nbsp;'Allocations'\nfrom&nbsp;wf_todo&nbsp;t\ninner&nbsp;join&nbsp;&nbsp;qr_draftreviewbatch&nbsp;b&nbsp;&nbsp;on&nbsp;t.entityid=b.id\ninner&nbsp;join&nbsp;prj_project&nbsp;p&nbsp;on&nbsp;b.projectid=p.id\n\nwhere&nbsp;&nbsp;t.workitem_state&nbsp;=&nbsp;10&nbsp;and&nbsp;t.flowcode&nbsp;is&nbsp;not&nbsp;&nbsp;null&nbsp;&nbsp;\nand&nbsp;exists&nbsp;(select&nbsp;code&nbsp;from&nbsp;Base_WorkFlowConfig&nbsp;where&nbsp;workflowtypeid&nbsp;=24615&nbsp;and&nbsp;flowcode&nbsp;=code)&nbsp;\nand&nbsp;t.entityStatus&nbsp;in('50','60')\n\nand&nbsp;(exists&nbsp;\n(select&nbsp;*&nbsp;from&nbsp;dbo.Base_Department&nbsp;d,Base_Department&nbsp;df,base_usergroupitem&nbsp;item\nwhere&nbsp;p.deptid&nbsp;=&nbsp;d.id&nbsp;and&nbsp;d.orgId&nbsp;=df.id&nbsp;and&nbsp;item.usergroupid&nbsp;=&nbsp;df.qualityControlGroupId&nbsp;and&nbsp;item.userid&nbsp;=#AppContext.Profile.Id#)&nbsp;or&nbsp;actor_id&nbsp;=#AppContext.Profile.Id#)\nand&nbsp;exists&nbsp;(select&nbsp;*&nbsp;from&nbsp;qr_reviewallocation&nbsp;a&nbsp;where&nbsp;&nbsp;b.id=a.draftreviewbatchid&nbsp;and&nbsp;a.manuscriptReviewState&nbsp;=&nbsp;t.entityStatus&nbsp;and&nbsp;(a.userid=#AppContext.Profile.Id#&nbsp;or&nbsp;actor_id&nbsp;=#AppContext.Profile.Id#))\n"}
2020-04-02 02:49:17